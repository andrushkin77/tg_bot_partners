name: Replace Base URLs in Code

on:
  workflow_dispatch:
    inputs:
      old_url:
        description: "–°—Ç–∞—Ä–∞—è –±–∞–∑–æ–≤–∞—è —Å—Å—ã–ª–∫–∞"
        required: true
      new_url:
        description: "–ù–æ–≤–∞—è –±–∞–∑–æ–≤–∞—è —Å—Å—ã–ª–∫–∞"
        required: true

jobs:
  replace:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Replace URLs inside strings (JS, HTML, etc.)
        run: |
          echo "–ó–∞–º–µ–Ω—è–µ–º: ${{ github.event.inputs.old_url }} ‚Üí ${{ github.event.inputs.new_url }}"

          OLD=$(printf '%s\n' "${{ github.event.inputs.old_url }}" | sed -e 's/[]\/$*.^[]/\\&/g')
          NEW="${{ github.event.inputs.new_url }}"

          echo "üîç –ò—â–µ–º —Ñ–∞–π–ª—ã —Å –≤—Ö–æ–∂–¥–µ–Ω–∏–µ–º $OLD..."

          FILES=$(find . \
            -type f \
            \( -name "*.js" -o -name "*.ts" -o -name "*.html" -o -name "*.md" -o -name "*.json" \) \
            -not -path "./.github/workflows/*" \
            -exec grep -l "$OLD" {} \;)

          echo "üìÑ –ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: $(echo "$FILES" | wc -l)"

          for file in $FILES; do
            echo "‚öôÔ∏è –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º: $file"
            sed -i "s|$OLD|$NEW|g" "$file"
          done

      - name: Commit and push changes
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add -u
          git diff --quiet && echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚Äî –ø—É—à –Ω–µ –Ω—É–∂–µ–Ω." || (
            git commit -m "üîÅ –ó–∞–º–µ–Ω–∏–ª –±–∞–∑–æ–≤—É—é —Å—Å—ã–ª–∫—É: ${{ github.event.inputs.old_url }} ‚Üí ${{ github.event.inputs.new_url }}"
            git push https://x-access-token:${TOKEN}@github.com/${{ github.repository }} HEAD:${{ github.ref_name }}
          )
