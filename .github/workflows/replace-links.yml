name: Replace URLs Everywhere

on:
  workflow_dispatch:
    inputs:
      old_url:
        description: "–°—Ç–∞—Ä–∞—è —Å—Å—ã–ª–∫–∞"
        required: true
      new_url:
        description: "–ù–æ–≤–∞—è —Å—Å—ã–ª–∫–∞"
        required: true

jobs:
  replace:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Replace URLs (—ç–∫—Ä–∞–Ω —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤, –±–µ–∑ .github/workflows)
        run: |
          echo "–ó–∞–º–µ–Ω—è–µ–º: ${{ github.event.inputs.old_url }} ‚Üí ${{ github.event.inputs.new_url }}"

          OLD=$(printf '%s\n' "${{ github.event.inputs.old_url }}" | sed -e 's/[]\/$*.^[]/\\&/g')
          NEW="${{ github.event.inputs.new_url }}"

          find . \
            -type f \
            \( -name "*.html" -o -name "*.js" -o -name "*.ts" -o -name "*.md" \) \
            -not -path "./.github/workflows/*" \
            -exec sed -i "s|$OLD|$NEW|g" {} +

      - name: Commit and push changes
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add -u
          git diff --quiet && echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚Äî –ø—É—à –Ω–µ –Ω—É–∂–µ–Ω." || (
            git commit -m "üîÅ –ó–∞–º–µ–Ω–∏–ª —Å—Å—ã–ª–∫–∏: ${{ github.event.inputs.old_url }} ‚Üí ${{ github.event.inputs.new_url }}"
            git push https://x-access-token:${TOKEN}@github.com/${{ github.repository }} HEAD:${{ github.ref_name }}
          )
