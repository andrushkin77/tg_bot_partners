name: Replace Base URLs in Code

on:
  workflow_dispatch:
    inputs:
      old_url:
        description: "–°—Ç–∞—Ä–∞—è –±–∞–∑–æ–≤–∞—è —Å—Å—ã–ª–∫–∞"
        required: true
        default: "https://866m82-169-150-209-165.ru.tuna.am"
      new_url:
        description: "–ù–æ–≤–∞—è –±–∞–∑–æ–≤–∞—è —Å—Å—ã–ª–∫–∞"
        required: true
        default: "https://5uzw5q-95-164-118-165.ru.tuna.am"

jobs:
  replace:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Replace Base URLs
        run: |
          # –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
          OLD="${{ github.event.inputs.old_url }}"
          NEW="${{ github.event.inputs.new_url }}"
          echo "–ó–∞–º–µ–Ω–∞ –±–∞–∑–æ–≤–æ–π —Å—Å—ã–ª–∫–∏: $OLD ‚Üí $NEW"
          
          # –î–ª—è –æ—Ç–ª–∞–¥–∫–∏: –∏—â–µ–º —Ñ–∞–π–ª—ã, –≥–¥–µ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è —Å—Ç–∞—Ä–∞—è —Å—Å—ã–ª–∫–∞
          echo "–ü–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤, —Å–æ–¥–µ—Ä–∂–∞—â–∏—Ö '$OLD':"
          grep -R "$OLD" . --exclude-dir=.git --exclude-dir=.github || echo "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ."

          # –ù–∞—Ö–æ–¥–∏–º —Ñ–∞–π–ª—ã –Ω—É–∂–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∏ –¥–µ–ª–∞–µ–º –∑–∞–º–µ–Ω—É
          find . -type f \( -name "*.js" -o -name "*.ts" -o -name "*.html" -o -name "*.md" -o -name "*.json" \) \
            -not -path "./.github/workflows/*" \
            -exec sed -i "s|$OLD|$NEW|g" {} +
          
          echo "–ó–∞–º–µ–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞."

      - name: Commit and push changes
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add -u
          # –ï—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç, –≤—ã–≤–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –∏–Ω–∞—á–µ –∫–æ–º–º–∏—Ç–∏–º –∏ –ø—É—à–∏–º
          git diff --quiet && echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚Äî –ø—É—à –Ω–µ –Ω—É–∂–µ–Ω." || (
            git commit -m "üîÅ –ó–∞–º–µ–Ω–µ–Ω—ã —Å—Å—ã–ª–∫–∏: ${{ github.event.inputs.old_url }} ‚Üí ${{ github.event.inputs.new_url }}"
            git push https://x-access-token:${TOKEN}@github.com/${{ github.repository }} HEAD:${{ github.ref_name }}
          )
