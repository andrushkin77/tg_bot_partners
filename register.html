<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Регистрация партнёра</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body{background:#161616;color:#fff;font-family:Arial;padding:20px}
    h2{margin-bottom:20px;text-align:center}
    label{display:block;margin-top:12px}
    input,textarea,button{width:100%;padding:10px;margin-top:6px;border:none;border-radius:6px;font-size:14px}
    input,textarea{background:#292929;color:#fff}
    button{background:#32CD32;color:#fff;font-weight:bold;margin-top:20px;cursor:pointer}
    #preview{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    #preview img{width:66px;height:66px;object-fit:cover;border-radius:4px}
    small{color:#aaa}
  </style>
</head>
<body>
<h2>Регистрация партнёра</h2>

<label>Название компании</label>
<input id="name" placeholder="ООО «Цветы»">

<label>Город</label>
<input id="city" placeholder="Москва">

<label>Адрес</label>
<input id="address" placeholder="ул. Ленина 1">

<label>Короткое описание</label>
<textarea id="description" rows="3" placeholder="Чем вы занимаетесь"></textarea>

<label>Email</label>
<input id="email" type="email">

<label>Пароль</label>
<input id="password" type="password">

<label>Фотографии (до 5 шт.) <small>jpeg/png/webp</small></label>
<input id="photoInput" type="file" accept="image/*" multiple>
<div id="preview"></div>

<button onclick="register()">Зарегистрироваться</button>

<script>
const tg = (window.Telegram && Telegram.WebApp) ? Telegram.WebApp : null;
if(tg) tg.expand();

const apiBase = "https://kwk2ke-169-150-209-165.ru.tuna.am/api";

/* -------- предпросмотр выбранных файлов -------- */
photoInput.onchange = () => {
  preview.innerHTML = "";
  [...photoInput.files].slice(0,5).forEach(f=>{
    const img = document.createElement("img");
    img.src = URL.createObjectURL(f);
    preview.appendChild(img);
  });
};

/* --------------- регистрация партнёра ---------- */
async function register(){
  const files = Array.from(photoInput.files).slice(0,5);
  const photos = [];

  /* 1. Загружаем каждый файл на /api/upload_photo и собираем URL-ы */
  for(const file of files){
    const fd = new FormData(); fd.append("photo", file);
    const res = await fetch(`${apiBase}/upload_photo`, {method:"POST", body:fd});
    const j   = await res.json();
    if(j.status !== "success"){
      alert("Ошибка загрузки фото: "+(j.message||""));
      return;
    }
    photos.push(j.url);
  }

  /* 2. Формируем payload и отправляем в Telegram-бот */
  const payload = {
    action:       "register",
    telegram_id:  tg ? tg.initDataUnsafe.user.id : 0,
    name:         name.value.trim(),
    city:         city.value.trim(),
    address:      address.value.trim(),
    description:  description.value.trim(),
    email:        email.value.trim(),
    password:     password.value,
    photos
  };

  if(tg){
    tg.sendData(JSON.stringify(payload));
    tg.close();
  }else{
    /* fallback для отладки в браузере */
    alert("TEST JSON:\n"+JSON.stringify(payload,null,2));
  }
}
</script>
</body>
</html>
